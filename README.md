# üíº Sistema de Gesti√≥n de N√≥minas - Backend

![.NET](https://img.shields.io/badge/.NET-8.0-512BD4?style=for-the-badge&logo=dotnet)
![C#](https://img.shields.io/badge/C%23-239120?style=for-the-badge&logo=c-sharp)
![SQL Server](https://img.shields.io/badge/SQL%20Server-CC2927?style=for-the-badge&logo=microsoft-sql-server)
![Azure](https://img.shields.io/badge/Azure-0078D4?style=for-the-badge&logo=microsoft-azure)
![JWT](https://img.shields.io/badge/JWT-000000?style=for-the-badge&logo=JSON%20web%20tokens)

Sistema completo de gesti√≥n de n√≥minas empresariales desarrollado con ASP.NET Core 8.0, dise√±ado para automatizar el c√°lculo, procesamiento y distribuci√≥n de n√≥minas con seguridad empresarial y trazabilidad completa.

---

## üìã Tabla de Contenidos

- [Caracter√≠sticas Principales](#-caracter√≠sticas-principales)
- [Tecnolog√≠as](#Ô∏è-tecnolog√≠as)
- [Arquitectura](#-arquitectura)
- [Requisitos Previos](#-requisitos-previos)
- [Instalaci√≥n](#-instalaci√≥n)
- [Configuraci√≥n](#Ô∏è-configuraci√≥n)
- [Estructura del Proyecto](#-estructura-del-proyecto)
- [Endpoints Principales](#-endpoints-principales)
- [Base de Datos](#Ô∏è-base-de-datos)
- [Seguridad](#-seguridad)
- [Reportes](#-reportes)
- [Testing](#-testing)
- [Deployment](#-deployment)
- [Contribuci√≥n](#-contribuci√≥n)
- [Licencia](#-licencia)

---

## ‚ú® Caracter√≠sticas Principales

### üéØ Gesti√≥n de Empleados
- ‚úÖ CRUD completo de empleados con validaciones
- ‚úÖ Gesti√≥n de departamentos y puestos
- ‚úÖ Expedientes digitales con Azure Blob Storage
- ‚úÖ Informaci√≥n acad√©mica y laboral
- ‚úÖ Activaci√≥n/desactivaci√≥n con validaciones de integridad

### üí∞ Procesamiento de N√≥minas
- ‚úÖ C√°lculo autom√°tico con bonificaciones y deducciones
- ‚úÖ Soporte para n√≥minas ordinarias y extraordinarias
- ‚úÖ C√°lculo por departamento, empleado o empresa completa
- ‚úÖ Estados: Borrador, Procesada, Aprobada, Pagada, Anulada
- ‚úÖ Validaci√≥n de duplicados por per√≠odo
- ‚úÖ Historial completo de cambios

### üìä Reportes y Documentaci√≥n
- ‚úÖ 16+ tipos de reportes (PDF, Excel, CSV)
- ‚úÖ Reportes de n√≥minas, empleados, deducciones, bonificaciones
- ‚úÖ Reportes de expedientes con filtros avanzados
- ‚úÖ Dashboard con m√©tricas en tiempo real
- ‚úÖ Estad√≠sticas por departamento

### üîê Seguridad y Auditor√≠a
- ‚úÖ Autenticaci√≥n JWT con refresh tokens
- ‚úÖ Autorizaci√≥n basada en roles (Admin, RRHH, Usuario)
- ‚úÖ Auditor√≠a completa de todas las operaciones
- ‚úÖ Logs detallados con informaci√≥n del usuario
- ‚úÖ Middleware de manejo de errores centralizado

### üìÅ Gesti√≥n Documental
- ‚úÖ Almacenamiento en Azure Blob Storage
- ‚úÖ URLs SAS para acceso seguro y temporal
- ‚úÖ Validaci√≥n de tipos de documento
- ‚úÖ Historial de documentos por empleado
- ‚úÖ Observaciones y validaciones de expedientes

---

## üõ†Ô∏è Tecnolog√≠as

### Backend
- **Framework:** ASP.NET Core 8.0
- **Lenguaje:** C# 12
- **ORM:** Entity Framework Core 8.0
- **Base de Datos:** SQL Server 2019+
- **Autenticaci√≥n:** JWT Bearer Tokens
- **Documentaci√≥n API:** Swagger/OpenAPI

### Librer√≠as Principales
- **QuestPDF** - Generaci√≥n de reportes PDF profesionales
- **ClosedXML** - Exportaci√≥n a Excel
- **BCrypt.Net** - Hashing seguro de contrase√±as
- **Azure.Storage.Blobs** - Almacenamiento en la nube

### Herramientas de Desarrollo
- **Visual Studio 2022** / **VS Code**
- **SQL Server Management Studio (SSMS)**
- **Postman** / **Swagger UI** para testing
- **Git** para control de versiones

---

## üèó Arquitectura

```
ProyectoNomina/
‚îÇ
‚îú‚îÄ‚îÄ ProyectoNomina.Backend/          # API REST
‚îÇ   ‚îú‚îÄ‚îÄ Controllers/                 # Endpoints HTTP
‚îÇ   ‚îú‚îÄ‚îÄ Services/                    # L√≥gica de negocio
‚îÇ   ‚îú‚îÄ‚îÄ Data/                        # DbContext y configuraci√≥n EF
‚îÇ   ‚îú‚îÄ‚îÄ Models/                      # Entidades del dominio
‚îÇ   ‚îú‚îÄ‚îÄ Middleware/                  # Middleware personalizado
‚îÇ   ‚îú‚îÄ‚îÄ Filters/                     # Filtros de acci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ Migrations/                  # Migraciones de base de datos
‚îÇ
‚îî‚îÄ‚îÄ ProyectoNomina.Shared/           # DTOs y modelos compartidos
    ‚îî‚îÄ‚îÄ Models/DTOs/                 # Data Transfer Objects
```

### Patr√≥n de Dise√±o
- **Repository Pattern** con Entity Framework Core
- **Dependency Injection** para servicios
- **DTO Pattern** para transferencia de datos
- **Middleware Pipeline** para manejo de errores y auditor√≠a

---

## üì¶ Requisitos Previos

### Software Requerido
- [.NET 8.0 SDK](https://dotnet.microsoft.com/download/dotnet/8.0) o superior
- [SQL Server 2019+](https://www.microsoft.com/sql-server) o SQL Server Express
- [Visual Studio 2022](https://visualstudio.microsoft.com/) o [VS Code](https://code.visualstudio.com/)
- [Git](https://git-scm.com/)

### Opcional
- [SQL Server Management Studio (SSMS)](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms)
- [Azure Storage Account](https://azure.microsoft.com/services/storage/) (para almacenamiento de archivos)
- [Postman](https://www.postman.com/) para testing de API

---

## üöÄ Instalaci√≥n

### 1. Clonar el Repositorio
```bash
git clone https://github.com/GuillermoGome2z/Backend-Nominas.git
cd Backend-Nominas
```

### 2. Restaurar Dependencias
```bash
dotnet restore
```

### 3. Configurar Base de Datos
Edita `appsettings.json` con tu cadena de conexi√≥n:
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost\\SQLEXPRESS;Database=ProyectoNomina2025;Trusted_Connection=True;TrustServerCertificate=True;"
  }
}
```

### 4. Aplicar Migraciones
```bash
cd ProyectoNomina.Backend
dotnet ef database update
```

### 5. Cargar Datos Iniciales (Opcional)
Ejecuta el script `SeedData.sql` en SQL Server para cargar datos de prueba.

### 6. Ejecutar el Proyecto
```bash
dotnet run
```

La API estar√° disponible en: `http://localhost:5009`

Swagger UI: `http://localhost:5009/swagger`

---

## ‚öôÔ∏è Configuraci√≥n

### appsettings.json

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost\\SQLEXPRESS;Database=ProyectoNomina2025;Trusted_Connection=True;TrustServerCertificate=True;"
  },
  
  "JwtSettings": {
    "SecretKey": "TU_CLAVE_SECRETA_MUY_SEGURA_DE_AL_MENOS_32_CARACTERES",
    "Issuer": "ProyectoNomina",
    "Audience": "ProyectoNominaUsuarios",
    "ExpirationHours": 1
  },
  
  "Cors": {
    "AllowedOrigins": [
      "http://localhost:5173",
      "https://tu-dominio-produccion.com"
    ],
    "AllowCredentials": true
  },
  
  "AzureBlob": {
    "Enabled": true,
    "ConnectionString": "DefaultEndpointsProtocol=https;AccountName=...;AccountKey=...;EndpointSuffix=core.windows.net",
    "ContainerName": "nomina-docs",
    "DefaultSasMinutes": 15
  },
  
  "Kestrel": {
    "Endpoints": {
      "Http": {
        "Url": "http://localhost:5009"
      }
    },
    "Limits": {
      "MaxRequestBodySize": 20971520
    }
  }
}
```

### Variables de Entorno (Producci√≥n)
```bash
export ConnectionStrings__DefaultConnection="Server=..."
export JwtSettings__SecretKey="tu_clave_super_secreta"
export AzureBlob__ConnectionString="DefaultEndpointsProtocol=https..."
```

---

## üìÅ Estructura del Proyecto

### Controllers (Endpoints)
- **AuthController** - Autenticaci√≥n y gesti√≥n de tokens
- **EmpleadosController** - CRUD de empleados
- **DepartamentoController** - Gesti√≥n de departamentos
- **PuestoController** - Gesti√≥n de puestos de trabajo
- **NominasController** - C√°lculo y procesamiento de n√≥minas
- **BonificacionesController** - Gesti√≥n de bonificaciones
- **DeduccionesController** - Gesti√≥n de deducciones
- **DocumentoEmpleadoController** - Gesti√≥n de documentos
- **ExpedientesController** - Expedientes de empleados
- **ReportesController** - Generaci√≥n de reportes
- **DashboardController** - M√©tricas y estad√≠sticas
- **AuditoriaController** - Consulta de logs

### Services (L√≥gica de Negocio)
- **NominaService** - C√°lculo de n√≥minas con bonificaciones/deducciones
- **ReporteService** - Generaci√≥n de reportes en m√∫ltiples formatos
- **ExpedientesReportService** - Reportes espec√≠ficos de expedientes
- **FileStorageService** - Gesti√≥n de archivos en Azure Blob

### Models (Entidades Principales)
- **Empleado** - Informaci√≥n del empleado
- **Departamento** - Departamentos de la empresa
- **Puesto** - Puestos de trabajo
- **Nomina** - N√≥mina principal
- **DetalleNomina** - Detalle por empleado
- **Bonificacion / Deduccion** - Conceptos de n√≥mina
- **DocumentoEmpleado** - Documentos digitales
- **Expediente** - Expedientes de empleados
- **Auditoria** - Logs de auditor√≠a
- **Usuario** - Usuarios del sistema

---

## üåê Endpoints Principales

### üîê Autenticaci√≥n
```http
POST   /api/Auth/login               # Login con email/password
POST   /api/Auth/refresh             # Renovar token con refresh token
POST   /api/Auth/logout              # Cerrar sesi√≥n
GET    /api/Auth/me                  # Informaci√≥n del usuario actual
```

### üë• Empleados
```http
GET    /api/Empleados                # Listar empleados (paginado)
GET    /api/Empleados/{id}           # Obtener empleado por ID
POST   /api/Empleados                # Crear nuevo empleado
PUT    /api/Empleados/{id}           # Actualizar empleado
DELETE /api/Empleados/{id}           # Eliminar empleado
PUT    /api/Empleados/{id}/activar   # Activar empleado
PUT    /api/Empleados/{id}/desactivar # Desactivar empleado
```

### üí∞ N√≥minas
```http
GET    /api/Nominas                  # Listar n√≥minas con filtros
GET    /api/Nominas/{id}             # Obtener n√≥mina por ID
POST   /api/Nominas/calcular         # Calcular preview de n√≥mina
POST   /api/Nominas/generar          # Generar n√≥mina nueva
POST   /api/Nominas/procesar/{id}    # Procesar n√≥mina
POST   /api/Nominas/aprobar/{id}     # Aprobar n√≥mina
POST   /api/Nominas/anular/{id}      # Anular n√≥mina
POST   /api/Nominas/{id}/email       # Enviar n√≥mina por email
```

### üìä Reportes
```http
GET    /api/Reportes/nominas/pdf                    # Reporte de n√≥minas en PDF
GET    /api/Reportes/nominas/excel                  # Reporte de n√≥minas en Excel
GET    /api/Reportes/empleados/pdf                  # Reporte de empleados en PDF
GET    /api/Reportes/expedientes/pdf                # Reporte de expedientes con filtros
GET    /api/Reportes/expedientes/estadisticas       # Estad√≠sticas de expedientes
```

### üìà Dashboard
```http
GET    /api/Dashboard/estadisticas   # M√©tricas generales del sistema
```

### üìÅ Documentos
```http
GET    /api/DocumentoEmpleado                       # Listar documentos
GET    /api/DocumentoEmpleado/empleado/{id}         # Documentos de un empleado
POST   /api/DocumentoEmpleado/upload                # Subir documento
DELETE /api/DocumentoEmpleado/{id}                  # Eliminar documento
```

---

## üóÑÔ∏è Base de Datos

### Diagrama ER Simplificado
```
Empleados ‚îÄ‚îÄ‚î¨‚îÄ‚Üí Departamentos
            ‚îú‚îÄ‚Üí Puestos
            ‚îî‚îÄ‚Üí DocumentosEmpleado

Nominas ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí DetalleNominas ‚îÄ‚îÄ‚Üí Empleados
            ‚îú‚îÄ‚Üí Bonificaciones
            ‚îî‚îÄ‚Üí Deducciones

Usuarios ‚îÄ‚îÄ‚îÄ‚Üí RefreshTokens
            ‚îî‚îÄ‚Üí Auditoria
```

### Migraciones
```bash
# Crear nueva migraci√≥n
dotnet ef migrations add NombreDeLaMigracion

# Aplicar migraciones
dotnet ef database update

# Revertir migraci√≥n
dotnet ef database update MigracionAnterior

# Ver historial
dotnet ef migrations list
```

---

## üîê Seguridad

### Autenticaci√≥n JWT
El sistema utiliza JWT (JSON Web Tokens) con refresh tokens para autenticaci√≥n:

1. **Login** ‚Üí Recibe Access Token (1 hora) + Refresh Token (7 d√≠as)
2. **Requests** ‚Üí Incluir header: `Authorization: Bearer {access_token}`
3. **Renovaci√≥n** ‚Üí Usar `/api/Auth/refresh` con refresh token
4. **Logout** ‚Üí Revoca el refresh token activo

### Roles y Permisos
- **Admin** - Acceso completo al sistema
- **RRHH** - Gesti√≥n de n√≥minas, empleados y reportes
- **Usuario** - Consulta de informaci√≥n limitada

### Headers Requeridos
```http
Authorization: Bearer {token}
Content-Type: application/json
```

### Ejemplo de Autenticaci√≥n
```bash
# Login
curl -X POST http://localhost:5009/api/Auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "correo": "admin@empresa.com",
    "clave": "Admin123"
  }'

# Usar el token
curl -X GET http://localhost:5009/api/Empleados \
  -H "Authorization: Bearer {tu_token_aqui}"
```

---

## üìÑ Reportes

### Tipos de Reportes Disponibles

#### 1. Reportes de N√≥minas
- **PDF** - Formato profesional con detalles completos
- **Excel** - Editable, m√∫ltiples hojas con res√∫menes
- **CSV** - Compatible con importaci√≥n/exportaci√≥n

#### 2. Reportes de Empleados
- Listado completo con departamentos
- Filtros por estado, departamento, puesto
- Exportaci√≥n masiva

#### 3. Reportes de Expedientes
- Estado de documentaci√≥n por empleado
- Documentos requeridos vs presentados
- Estad√≠sticas de cumplimiento por departamento

#### 4. Reportes Financieros
- Deducciones por per√≠odo
- Bonificaciones por empleado/departamento
- An√°lisis de n√≥mina hist√≥rica

### Generaci√≥n de Reportes
```csharp
// Ejemplo: Reporte de expedientes con filtros
GET /api/Reportes/expedientes/pdf?estado=Incompleto&departamentoId=1
```

---

## üß™ Testing

### Ejecutar Tests
```bash
dotnet test
```

### Testing Manual con Swagger
1. Navegar a `http://localhost:5009/swagger`
2. Autenticarse usando `/api/Auth/login`
3. Copiar el token en el bot√≥n "Authorize"
4. Probar endpoints directamente

### Testing con Postman
Importar la colecci√≥n desde `postman_collection.json` (si est√° disponible)

---

## üöÄ Deployment

### Publicaci√≥n Local
```bash
dotnet publish -c Release -o ./publish
```

### Docker (Opcional)
```dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base
WORKDIR /app
EXPOSE 5009

FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY . .
RUN dotnet restore
RUN dotnet publish -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=build /app/publish .
ENTRYPOINT ["dotnet", "ProyectoNomina.Backend.dll"]
```

### Azure App Service
1. Crear App Service en Azure Portal
2. Configurar cadenas de conexi√≥n en Application Settings
3. Desplegar desde Visual Studio o Azure DevOps

### Variables de Entorno Producci√≥n
```bash
ASPNETCORE_ENVIRONMENT=Production
ConnectionStrings__DefaultConnection="..."
JwtSettings__SecretKey="..."
AzureBlob__ConnectionString="..."
```

---

## üìù Logs y Auditor√≠a

### Sistema de Auditor√≠a
Todas las operaciones quedan registradas con:
- ‚úÖ Usuario que ejecut√≥ la acci√≥n
- ‚úÖ Endpoint accedido
- ‚úÖ M√©todo HTTP utilizado
- ‚úÖ Detalles de la operaci√≥n
- ‚úÖ Timestamp preciso

### Consultar Logs
```http
GET /api/Auditoria?page=1&pageSize=50
GET /api/Auditoria/usuario/{userId}
GET /api/Auditoria?fechaInicio=2025-01-01&fechaFin=2025-12-31
```

---

## ü§ù Contribuci√≥n

### Flujo de Trabajo
1. Fork el repositorio
2. Crear branch para feature: `git checkout -b feature/nueva-funcionalidad`
3. Commit cambios: `git commit -m 'feat: Agregar nueva funcionalidad'`
4. Push al branch: `git push origin feature/nueva-funcionalidad`
5. Crear Pull Request

### Convenci√≥n de Commits
- `feat:` Nueva funcionalidad
- `fix:` Correcci√≥n de bug
- `docs:` Cambios en documentaci√≥n
- `style:` Formato, punto y coma faltante, etc.
- `refactor:` Refactorizaci√≥n de c√≥digo
- `test:` Agregar tests
- `chore:` Actualizar dependencias, tareas de mantenimiento

---

## üìû Soporte

### Recursos
- **Documentaci√≥n API:** `http://localhost:5009/swagger`
- **Issues:** [GitHub Issues](https://github.com/GuillermoGome2z/Backend-Nominas/issues)
- **Wiki:** [GitHub Wiki](https://github.com/GuillermoGome2z/Backend-Nominas/wiki)

### Contacto
- **Desarrollador:** Guillermo G√≥mez
- **GitHub:** [@GuillermoGome2z](https://github.com/GuillermoGome2z)

---

## üìú Licencia

Este proyecto est√° bajo la Licencia MIT - ver el archivo [LICENSE](LICENSE) para m√°s detalles.

---

## üéØ Roadmap

### Versi√≥n Actual (v1.0)
- ‚úÖ CRUD completo de empleados
- ‚úÖ Sistema de n√≥minas con c√°lculos autom√°ticos
- ‚úÖ Reportes en PDF/Excel/CSV
- ‚úÖ Autenticaci√≥n JWT
- ‚úÖ Auditor√≠a completa

### Pr√≥ximas Versiones
- üîú API de notificaciones (email/SMS)
- üîú Integraci√≥n con sistemas contables
- üîú Portal de autogesti√≥n para empleados
- üîú App m√≥vil (React Native)
- üîú An√°lisis predictivo con ML
- üîú Integraci√≥n con biom√©tricos

---

## üôè Agradecimientos

Gracias a todos los que han contribuido a este proyecto y a las siguientes tecnolog√≠as que lo hacen posible:
- ASP.NET Core Team
- Entity Framework Core Team
- QuestPDF Community
- Azure Storage Team

---

## üìä Estado del Proyecto

![GitHub last commit](https://img.shields.io/github/last-commit/GuillermoGome2z/Backend-Nominas)
![GitHub issues](https://img.shields.io/github/issues/GuillermoGome2z/Backend-Nominas)
![GitHub stars](https://img.shields.io/github/stars/GuillermoGome2z/Backend-Nominas)
![GitHub forks](https://img.shields.io/github/forks/GuillermoGome2z/Backend-Nominas)

---

<div align="center">
  <p>Desarrollado con ‚ù§Ô∏è usando ASP.NET Core 8.0</p>
  <p>¬© 2025 Sistema de Gesti√≥n de N√≥minas. Todos los derechos reservados.</p>
</div>
